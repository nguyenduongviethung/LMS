// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
}

model User {
    userId       Int          @id @default(autoincrement())
    stateId      Int
    state        State        @relation(fields: [stateId], references: [stateId])
    roleId       Int
    role         Role         @relation(fields: [roleId], references: [roleId])
    name         String
    birthDate    DateTime?
    email        String       @unique
    phone        String?
    password     String
    studyPlace   String?
    workPlace    String?
    refreshToken String?
    otp          String?
    isDeleted    Boolean      @default(false)
    createdAt    DateTime     @default(now())
    updatedAt    DateTime     @updatedAt
    userClasses  UserClass[]
    reviews      Review[]
    tuitions     Tuition[]
    attendances  Attendance[]
    taskResults  TaskResult[]
}

model Class {
    classId        Int         @id @default(autoincrement())
    stateId        Int
    state          State       @relation(fields: [stateId], references: [stateId])
    name           String
    description    String?
    defaultTuition Float?
    isDeleted      Boolean     @default(false)
    createdAt      DateTime    @default(now())
    updatedAt      DateTime    @updatedAt
    userClasses    UserClass[]
    reviews        Review[]
    tuitions       Tuition[]
    schedules      Schedule[]
    sessions       Session[]
}

model UserClass {
    userId     Int
    user       User     @relation(fields: [userId], references: [userId])
    classId    Int
    class      Class    @relation(fields: [classId], references: [classId])
    stateId    Int
    state      State    @relation(fields: [stateId], references: [stateId])
    roleId     Int
    role       Role     @relation(fields: [roleId], references: [roleId])
    enrolledAt DateTime @default(now())
    isDeleted  Boolean  @default(false)

    @@id([userId, classId])
}

model State {
    stateId     Int          @id @default(autoincrement())
    stateName   String
    stateType   String
    users       User[]
    classes     Class[]
    userClasses UserClass[]
    tuitions    Tuition[]
    attendances Attendance[]
    taskResults TaskResult[]
}

model Role {
    roleId       Int           @id @default(autoincrement())
    roleName     String
    roleType     String
    users        User[]
    userClasses  UserClass[]
    contentFiles ContentFile[]
}

model Review {
    reviewId      Int     @default(autoincrement())
    userId        Int
    user          User    @relation(fields: [userId], references: [userId])
    classId       Int
    class         Class   @relation(fields: [classId], references: [classId])
    month         Int
    year          Int
    goodAttitude  String?
    badAttitude   String?
    goodSkills    String?
    badSkills     String?
    goodKnowledge String?
    badKnowledge  String?

    @@id([userId, classId, month, year])
}

model Tuition {
    tuitionId Int   @default(autoincrement())
    userId    Int
    user      User  @relation(fields: [userId], references: [userId])
    classId   Int
    class     Class @relation(fields: [classId], references: [classId])
    stateId   Int
    state     State @relation(fields: [stateId], references: [stateId])
    month     Int
    year      Int
    amount    Float

    @@id([userId, classId, month, year])
}

model Schedule {
    scheduleId Int    @id @default(autoincrement())
    classId    Int
    class      Class  @relation(fields: [classId], references: [classId])
    weekday    Int
    startTime  String
    duration   Int
}

model Session {
    sessionId         Int              @id @default(autoincrement())
    templateSessionId Int?
    templateSession   TemplateSession? @relation(fields: [templateSessionId], references: [templateSessionId])
    classId           Int
    class             Class            @relation(fields: [classId], references: [classId])
    name              String
    description       String?
    startTime         DateTime?
    duration          Int?
    isDeleted         Boolean          @default(false)
    createdAt         DateTime         @default(now())
    updatedAt         DateTime         @updatedAt
    attendances       Attendance[]
    sessionContents   SessionContent[]
}

model Attendance {
    userId    Int
    user      User    @relation(fields: [userId], references: [userId])
    sessionId Int
    session   Session @relation(fields: [sessionId], references: [sessionId])
    stateId   Int
    state     State   @relation(fields: [stateId], references: [stateId])
    note      String?

    @@id([userId, sessionId])
}

model TaskResult {
    userId    Int
    user      User    @relation(fields: [userId], references: [userId])
    contentId Int
    content   Content @relation(fields: [contentId], references: [contentId])
    stateId   Int
    state     State   @relation(fields: [stateId], references: [stateId])
    score     Float?
    reviews   String?

    @@id([userId, contentId])
}

model TemplateSession {
    templateSessionId       Int                      @id @default(autoincrement())
    name                    String
    description             String?
    sessions                Session[]
    templateSessionContents TemplateSessionContent[]
}

model SessionContent {
    sessionId Int
    session   Session @relation(fields: [sessionId], references: [sessionId])
    contentId Int
    content   Content @relation(fields: [contentId], references: [contentId])

    @@id([sessionId, contentId])
}

model TemplateSessionContent {
    templateSessionId Int
    templateSession   TemplateSession @relation(fields: [templateSessionId], references: [templateSessionId])
    contentId         Int
    content           Content         @relation(fields: [contentId], references: [contentId])

    @@id([templateSessionId, contentId])
}

model Content {
    contentId               Int                      @id @default(autoincrement())
    name                    String
    description             String?
    contentType             String
    deadline                DateTime?
    cutoffScore             Float?
    createdAt               DateTime                 @default(now())
    sessionContents         SessionContent[]
    templateSessionContents TemplateSessionContent[]
    taskResults             TaskResult[]
    contentFiles            ContentFile[]
}

model File {
    fileId       Int           @id @default(autoincrement())
    filename     String
    filetype     String
    filepath     String
    filesize     Int
    uploadedAt   DateTime      @default(now())
    contentFiles ContentFile[]
}

model ContentFile {
    contentId Int
    content   Content @relation(fields: [contentId], references: [contentId])
    fileId    Int
    file      File    @relation(fields: [fileId], references: [fileId])
    roleId    Int
    role      Role    @relation(fields: [roleId], references: [roleId])

    @@id([contentId, fileId])
}
